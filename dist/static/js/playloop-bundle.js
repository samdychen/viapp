!function(e){function n(n){for(var i,r,s=n[0],l=n[1],c=n[2],_=0,u=[];_<s.length;_++)r=s[_],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&u.push(o[r][0]),o[r]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(e[i]=l[i]);for(p&&p(n);u.length;)u.shift()();return a.push.apply(a,c||[]),t()}function t(){for(var e,n=0;n<a.length;n++){for(var t=a[n],i=!0,s=1;s<t.length;s++){var l=t[s];0!==o[l]&&(i=!1)}i&&(a.splice(n--,1),e=r(r.s=t[0]))}return e}var i={},o={3:0},a=[];function r(n){if(i[n])return i[n].exports;var t=i[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,r),t.l=!0,t.exports}r.m=e,r.c=i,r.d=function(e,n,t){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)r.d(t,i,function(n){return e[n]}.bind(null,i));return t},r.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(n,"a",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p="";var s=window.webpackJsonp=window.webpackJsonp||[],l=s.push.bind(s);s.push=n,s=s.slice();for(var c=0;c<s.length;c++)n(s[c]);var p=l;a.push([6,0]),t()}([,,,,,,function(e,n,t){const i=t(0),{CLIENT_TAG:o,WEBAPP_PATHS:a,APIS:r}=t(1),{UserSession:s}=t(7),{AiInteractor:l}=t(8),{PlayloopApp:c}=t(9),{FullInsert:p}=t(10),{StackInsert:_}=t(11);var u=window.top.local_ws;u?u.onCaching=function(e){g.show_detail("资源大小："+e.size+"MB，下载进度："+(100*e.process).toFixed(2)+"%")}:console.log("global local_ws is not defined.");var d,f,y,g=new c("playloop");g.init().then((function(){g.onDisplayStart=function(e){u.send_behavior("playloop",e)},(f=new p(g)).onInsert=function(e){let n=(new Date).getTime();u.send_behavior("full_insert",e),console.log("[action] onInsert Func Done: ",(new Date).getTime()-n)},y=new _(g);var e=g.configs.ai_conf||[];(d=new l(e,g,f,y)).init().then((function(){d.onAction=function(e){u.send_data("interact",e)},g.play()})).catch((function(e){g.show_tip(e,"error"),setTimeout(playloop.play,3e3)}))}));var v=new s(o),w={};v.onUserSessionOn=function(e){var n=e.session_id||"unkown";w[n]=e,e.cur_user_sessions_counts=Object.keys(w).length,d.exec(e)},v.onUserSessionKeep=function(e){var n=e.session_id||"unkown";w[n]=e,e.cur_user_sessions_counts=Object.keys(w).length,d.exec(e)},v.onUserSessionOff=function(e){var n=e.session_id||"unkown";delete w[n],e.cur_user_sessions_counts=Object.keys(w).length,d.exec(e)},v.open(),i("body").click((function(){v.send_screen_clicked_event()}))},function(e,n){e.exports={UserSession:function(e){var n,t=this;n=""==window.location.host?"127.0.0.1:5000":window.location.host,t.service_id="user_session",t.ws_url="ws://"+n+"/service/page_ws/"+t.service_id+"/"+e,t.ws=null;var i=["onUserSessionOn","onUserSessionKeep","onUserSessionOff"],o={EVENT_USER_SESSION_ON:"onUserSessionOn",EVENT_USER_SESSION_KEEP:"onUserSessionKeep",EVENT_USER_SESSION_OFF:"onUserSessionOff"},a=function(){for(var e=0;e<i.length;e++){var n=i[e];t[n]=e=>{console.log(n)}}};t.open=function(){return new Promise((function(e,n){t.user_close=!1,t.ws=new WebSocket(t.ws_url),t.ws.onmessage=function(e){var n=JSON.parse(e.data);console.log(t.service_id+" receive:",n);var i=n.type;if(i in o){var a=o[i];a in t&&t[a](n.data)}},t.ws.onopen=function(){console.log("["+t.service_id+"] websocket connection establish successfully"),e(!0)},t.ws.onclose=function(e){console.log("["+t.service_id+"] websocket is closed"),t.user_close||setTimeout(()=>{t.ws&&t.ws.readyState!=t.ws.CLOSED||t.open()},3e3)},t.ws.onerror=function(e){console.log("["+t.service_id+"] websocket connect failed"),setTimeout(()=>{t.ws&&t.ws.readyState!=t.ws.CLOSED||t.open()},3e3),n&&n(e)}}))},t.close=function(){t.user_close=!0,t.ws.close(),a()};var r=function(e){if(t.ws.readyState==t.ws.OPEN){var n=JSON.stringify({uuid:"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/x/g,(function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})),type:"EVENT_CLICK",data:e});t.ws.send(n)}else console.error(t.service_id,"is not open:",t.ws.readyState)};t.send_screen_clicked_event=function(){if(t.ws.readyState==t.ws.OPEN){var e={type:"screen",time:(new Date).getTime()/1e3};r(e)}else console.error(t.service_id,"is not open:",t.ws.readyState)},t.send_product_clicked_event=function(e){if(t.ws.readyState==t.ws.OPEN){var n={type:"product",product_id:[e],time:(new Date).getTime()/1e3};r(n)}else console.error(t.service_id,"is not open:",t.ws.readyState)},a()}}},function(e,n){e.exports={AiInteractor:function(e,n,t,i){var o=this;o.playloop_app=n,o.full_inserter=t,o.stack_inserter=i,o.onAction=function(e){};var a=function(e){var n=!1;return $.post({url:"/webapp/"+e+"/check",cache:!1,async:!1,dataType:"json",success:function(e){1==e.status&&(n=!0)}}),n},r=function(e,n){return new Promise((function(t,i){$.post({url:"/webapp/download",contentType:"application/json",cache:!1,data:JSON.stringify({webapp_src:e,webapp_name:n}),dataType:"json",success:function(e){1==e.status?t(!0):i(e.message)},error:function(e){i("发生未知错误")}})}))};o.action_types={full_insert:function(e){o.full_inserter.insert(e)},stack_insert:function(e){o.stack_inserter.insert(e)},goto_webapp:function(e){var n,t,i=e.path;if(i){if(console.log("准备进入app",i),n=i,t=!1,$.get({url:n,cache:!1,async:!1,success:function(){t=!0}}),!t)throw"app不存在，"+i;o.playloop_app.pause(),window.location.href=i+"?time="+(new Date).getTime()}else console.log("没有设置app地址")}},o.interaction_types={say_hello:function(e,n){if(o.full_inserter.inserting&&e.cur_user_sessions_counts>1)return!1;if("tag"in n&&!(n.tag in e.tag))return!1;if("gender"in n){var t=(e.face_attribution||{}).gender;if(n.gender!=t)return!1}if("age"in n){var i=n.age[0],a=n.age[1],r=(e.face_attribution||{}).age||0;if(!(r>=i&&r<a))return!1}if("is_vip"in n){var s=(e.face_attribution||{}).is_vip;if(n.is_vip!=s)return!1}return console.log("say_hello_interaction will return true"),!0},product_interact:function(e,n){if("no_preemption"in n)if(o.full_inserter.inserting){if(n.no_preemption.indexOf(o.full_inserter.inserted_display_id)>-1)return!1}else{var t=o.playloop_app.current_display_index;if(t>=0){var i=o.playloop_app.configs.playlist.display_list[t].display_id;if(n.no_preemption.indexOf(i)>-1)return!1}}if("product_id"in n){if(0==n.product_id.length)return!1;for(var a=0;a<n.product_id.length;a++){var r=n.product_id[a];if(e.product_id.indexOf(r)<0)return!1}}if("sensitive_type"in n){var s=n.sensitive_type.toLowerCase();if("fast"==s){if(["HAND_ON","HAND_KEEP"].indexOf(e.update_trigger)<0)return!1}else if("medium"==s){if("HAND_KEEP"!=e.update_trigger)return!1}else if("slow"==s&&"HAND_OFF"!=e.update_trigger)return!1}return!0},screen_click:function(e,n){return!0}},o.exec=function(e){var n=function(e){var n="unkown";return"USER_SESSION_ON"==e.session_status?n="say_hello":"FOCUSING_ON"==e.behavior_type?n="product_interact":"SCREEN_CLICK"==e.behavior_type&&(n="screen_click"),n}(e);let t=(new Date).getTime();console.log("interaction type:",n);var i=o.interaction_types[n];if(i){for(var a=o.ai_interaction_configs[n]||[],r=null,s=0;s<a.length;s++){var l=a[s],c=l.condition_para||{};if(i(e,c)){r=l.action_para;break}}if(console.log("Done For",(new Date).getTime()-t),r){var p=r.action_type,_=o.action_types[p];if(_){var u=r.action_data;console.log("action: "+n+" "+p,(new Date).getTime()-t),_(u),console.log("action done: "+n+" "+p,(new Date).getTime()-t);var d={interaction_type:n,condition:c,action_type:_,action_data:u};"full_insert"==p||"stack_insert"==p?d.expired_time=u.display_time||30:"goto_webapp"==p&&(d.expired_time=30),o.onAction(d)}else console.error("not this action type:",p)}}return null!=r},o.init=function(){return new Promise((async function(n,t){o.playloop_app.show_tip("解析AI交互配置中..."),o.ai_interaction_configs={};for(var i=0;i<e.length;i++){var s=e[i],l=s.type;l in o.ai_interaction_configs||(o.ai_interaction_configs[l]=[]);for(var c=0;c<s.config_para.length;c++){var p=s.config_para[c].action_para.action_type;if("goto_webapp"==p){var _=(y=s.config_para[c].action_para.action_data).src,u=_.split("/").pop(),d=u.substr(0,u.length-7),f="/static/webapp/"+d+"/index.html";s.config_para[c].action_para.action_data.path=f,a(d)||(o.playloop_app.show_tip("下载应用："+y.name,"download"),await r(_,y.name).catch((function(e){t(e)})))}else if("full_insert"==p){var y=s.config_para[c].action_para.action_data;o.playloop_app.show_tip("正在互动页："+y.display_name,"download"),await o.playloop_app.render_display(y).catch((function(e){t(e)}))}}var g=o.ai_interaction_configs[l].concat(s.config_para);o.ai_interaction_configs[l]=g}n()}))}}}},function(e,n,t){const i=t(0),{CLIENT_TAG:o,WEBAPP_PATHS:a,APIS:r}=t(1);e.exports={PlayloopApp:function(e){var n=this;n.page_id=e,n.page=i("#"+e),n.display_list=[],n.display_time_ranges=[],n.display_total_time=0,n.onDisplayStart=function(e){};var t={success:"./media/success.png",error:"./media/error.png",info:"./media/info.png",download:"./media/download.png"},o=n.page.find(".tip_container");n.get_tip_text=function(){return o.find(".tip_text").text()},n.show_tip=function(e,i){setTimeout((function(){var a=t[i];o.find(".tip_icon").attr("src",a),o.find(".tip_title").text(e),o.find(".tip_text").text(""),n.paused&&o.show()}),0)},n.hide_tip=function(){o.hide()},n.show_detail=function(e){o.find(".tip_text").text(e)},n.get_configs=function(){var e={};return i.ajax({url:r.get_webapp_config.replace("<app_name>",n.page_id),type:"POST",cache:!1,async:!1,dataType:"json",success:function(n){if(1!=n.status)throw n.message;e=n.data||{}},error:function(e){throw e}}),e};var a=function(e,n,t){return new Promise((function(n,t){i.ajax({url:r.get_cache_url,type:"POST",contentType:"application/json",data:JSON.stringify({url:e}),dataType:"json",cache:!1,success:function(e){1==e.status?n(e.data):t(e.message)},error:function(e){t("发生未知的错误")}})}))},s=function(e){var n=i("<img>").attr({src:e.src});return n.css({position:"absolute",left:e.x,top:e.y,width:e.w,height:e.h,"object-fit":e.mode,"object-position":e.position||"center"}),n},l=function(e){var n=i("<video>").attr({src:e.src,autoplay:"autoplay",loop:"loop"});return n.css({position:"absolute",left:e.x,top:e.y,width:e.w,height:e.h,"object-fit":e.mode,"object-position":e.position||"center"}),n};n.render_display=function(e){return new Promise((async function(n,t){for(var o=i("<div>").css({position:"relative"}),r=e.widget_list||[],c=0;c<r.length;c++){var p,_=r[c];if("image"==_.type){var u=_.src,d=await a(u).catch((function(e){t(e)}));_.src=d,p=s(_)}else if("video"==_.type){u=_.src,d=await a(u).catch((function(e){t(e)}));_.src=d,p=l(_)}p&&o.append(p)}o.attr({display_id:e.display_id,display_name:e.display_name}),n(o)}))};var c,p=async function(e){for(var t=0;t<e.length;t++){var o=e[t];n.show_tip("正在加载播放列表（第"+(t+1)+"页 / 共"+e.length+"页）："+o.display_name,"download");var a=await n.render_display(o);n.display_list.push(a)}return function(){for(var e=[],t=0;t<n.display_list.length;t++){var o=n.display_list[t],a=i("<div>").append(o).html();e.push(a)}let r={display_html_list:e,display_time_ranges:n.display_time_ranges,display_total_time:n.display_total_time};localStorage.setItem("playloop",JSON.stringify(r))}(),!0};n.paused=!0,n.playlooper_step=100,n.current_display_index=-1,n.current_display_name="",n.display_container=n.page.find(".display_container"),n.play=function(){0==n.display_list.length?n.show_tip("播放列表为空，无法播放","error"):(n.hide_tip(),n.paused=!1,n.display_container.find("video, audio").each((function(){this.paused&&this.play()})),clearInterval(c),c=setInterval(_,n.playlooper_step))},n.pause=function(){n.paused=!0,clearInterval(c),n.display_container.find("video, audio").each((function(){this.pause()}))};var _=function(){var e,t=function(e){for(var t=-1,i=0;i<n.display_time_ranges.length;i++)if(e>=n.display_time_ranges[i][0]&&e<n.display_time_ranges[i][1]){t=i;break}return t}((60*(e=new Date).getUTCHours()*60+60*e.getUTCMinutes()+e.getUTCSeconds())%n.display_total_time);if(t!=n.current_display_index&&t>=0){var i=n.display_list[t];n.display_container.empty().append(i.clone()),n.current_display_index=t,n.current_display_name=i.attr("display_name");var o=n.configs.playlist.display_list[n.current_display_index],a={index:n.current_display_index,display_id:o.display_id,display_name:n.current_display_name,display_time:o.display_time,thumb_uri:o.thumb_uri,start_time:(new Date).getTime()/1e3};n.onDisplayStart(a)}};n.init=function(){return new Promise((async function(e,t){window.location.hash=n.page_id,n.show_tip("获取播放列表中，请稍候...","download");try{var o=n.get_configs();n.configs=o,localStorage.setItem("playloop_config",JSON.stringify(o));var a=(o.playlist||{}).display_list||[];if(n.show_tip("开始加载播放列表，请稍候...","download"),0==a.length)throw n.show_tip("未设置播放内容","error"),"未设置播放内容";!function(e){for(var t=0,i=[],o=0;o<e.length;o++){var a=e[o].display_time||0;i.push([t,t+a]),t+=a}n.display_time_ranges=i,n.display_total_time=t}(a),setTimeout((function(){p(a).then((function(){e()}))}),0)}catch(o){"playloop_config"in localStorage?(n.configs=localStorage.getItem("playloop_config"),function(){var e=localStorage.getItem("playloop");e=JSON.parse(e);for(var t=[],o=0;o<e.display_html_list.length;o++){var a=e.display_html_list[o];t.push(i(a))}n.display_list=t,n.display_time_ranges=e.display_time_ranges,n.display_total_time=e.display_total_time}(),e()):(console.error(o),n.show_tip(o,"error"),t(o))}}))}}}},function(e,n,t){const i=t(0);e.exports={FullInsert:function(e){var n=this;n.playlooper=e,n.inserting=!1,n.inserted_display_id="",n.inserting_timeout_handle=null,n.onInsert=function(e){},n.insert=async function(e){var t=e.display_id||"",o=e.update_while_playing||!1;if(!function(e){return n.inserted_display_id==e}(t)||o){var a;let o=(new Date).getTime();!function(e){return"full_insert_"+e in sessionStorage}(t)?function(e,n){var t="full_insert_"+e,o=i("<div>").append(n).html();sessionStorage.setItem(t,o)}(t,a=await n.playlooper.render_display(e)):a=function(e){var n="full_insert_"+e,t=sessionStorage.getItem(n);return i(t)}(t),console.log("[action] render display done: ",(new Date).getTime()-o),o=(new Date).getTime(),n.playlooper.pause(),n.inserting=!0,n.inserted_display_id=t,clearTimeout(n.inserting_timeout_handle),n.playlooper.display_container.empty().append(a),console.log("[action] render display done: ",(new Date).getTime()-o);var r=e.display_time;r>-1&&(n.inserting_timeout_handle=setTimeout(()=>{n.inserting=!1,n.inserted_display_id="",n.playlooper.play()},1e3*r));var s={display_id:e.display_id,display_name:e.display_name,thumb_uri:e.thumb_uri,start_time:(new Date).getTime()/1e3};n.onInsert(s)}else console.log(e.display_name+" is playing")}}}},function(e,n,t){t(0);e.exports={StackInsert:function(e){var n=this;n.playlooper=e,n.stack_container=e.page.find(".stack_container"),n.insertings={},n.insert=async function(e){var t=e.display_id||"",i=e.update_while_playing||!1;if(!function(e){return e in n.insertings}(t)||i){var o;o=await n.playlooper.render_display(e),n.stack_container.find("[display_id="+t+"]").remove(),clearTimeout(n.insertings[t]),n.stack_container.append(o);var a=e.display_time;if(a>-1){var r=setTimeout(()=>{delete n.insertings[t],o.remove()},1e3*a);n.insertings[t]=r}else n.insertings[t]=null}else console.log(e.display_name+" is playing")}}}}]);